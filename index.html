  <script>
    let data = {
      characters: [],
      problems: [],
      solutions: []
    };
    
    let selected = {
      character: null,
      problem: null
    };
    
    const SHEET_ID = '1MWFM0owF7Ca2RpgUmdLZCDCH3Hrwo6AK0sEnC1LTN4E';
    
    const URLS = {
      characters: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?gid=0&format=csv`,
      problems: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?gid=450933702&format=csv`,
      solutions: `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?gid=1374699678&format=csv`
    };
    
    async function loadData() {
      showLoading(true);
      try {
        const [charRes, probRes, solRes] = await Promise.all([
          fetch(URLS.characters),
          fetch(URLS.problems),
          fetch(URLS.solutions)
        ]);
        
        data.characters = parseCSV(await charRes.text());
        data.problems = parseCSV(await probRes.text());
        data.solutions = parseCSV(await solRes.text());
        
        renderCharacters();
        showLoading(false);
      } catch (error) {
        console.error('Error loading data:', error);
        showLoading(false);
        alert('Error loading data. Please refresh the page.');
      }
    }
    
    function parseCSV(csv) {
      const lines = csv.trim().split('\n');
      if (lines.length < 2) return [];
      
      const headers = lines[0].split('\t').map(h => h.trim());
      return lines.slice(1).map(line => {
        const values = line.split('\t').map(v => v.trim());
        const obj = {};
        headers.forEach((h, i) => {
          obj[h] = values[i] || '';
        });
        return obj;
      });
    }
    
    function renderCharacters() {
      const grid = document.getElementById('charactersGrid');
      grid.innerHTML = '';
      
      data.characters.forEach((char, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = () => selectCharacter(i);
        
        const img = char['link'] ? `<img src="${char['link']}" alt="${char.animal}" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">` : '';
        card.innerHTML = `${img}<div class="card-name">${char.animal}</div>`;
        grid.appendChild(card);
      });
    }
    
    function selectCharacter(index) {
      selected.character = data.characters[index];
      renderProblems();
      switchStage(2);
    }
    
    function randomCharacter() {
      const random = Math.floor(Math.random() * data.characters.length);
      selectCharacter(random);
    }
    
    function renderProblems() {
      const grid = document.getElementById('problemsGrid');
      grid.innerHTML = '';
      
      data.problems.forEach((prob, i) => {
        const card = document.createElement('div');
        card.className = 'card';
        card.onclick = () => selectProblem(i);
        
        const img = prob['image'] ? `<img src="${prob['image']}" alt="${prob.problem}" onerror="this.src='https://via.placeholder.com/150?text=No+Image'">` : '';
        card.innerHTML = `${img}<div class="card-name">${prob.problem}</div>`;
        grid.appendChild(card);
      });
    }
    
    function selectProblem(index) {
      selected.problem = data.problems[index];
      showSolution();
      switchStage(3);
    }
    
    function randomProblem() {
      const random = Math.floor(Math.random() * data.problems.length);
      selectProblem(random);
    }
    
    function showSolution() {
      const solution = data.solutions.find(
        sol => sol.animal === selected.character.animal && 
               sol.problem === selected.problem.problem
      );
      
      const resultArea = document.getElementById('resultArea');
      
      if (solution) {
        const img = solution['image'] ? `<img src="${solution['image']}" onerror="this.src='https://via.placeholder.com/300?text=No+Image'">` : '';
        resultArea.innerHTML = `
          <h2>${selected.character.animal} is ${selected.problem.problem}!</h2>
          <div class="result-text">Give it: <strong>${solution.solution}</strong></div>
          ${img}
        `;
      } else {
        resultArea.innerHTML = `
          <h2>Hmm... ðŸ¤”</h2>
          <div class="result-text">We don't have a solution for this yet!</div>
        `;
      }
    }
    
    function switchStage(stage) {
      document.querySelectorAll('.stage').forEach(s => s.classList.add('hidden'));
      document.getElementById(`stage${stage}`).classList.remove('hidden');
    }
    
    function backToCharacters() {
      selected.character = null;
      selected.problem = null;
      switchStage(1);
    }
    
    function resetGame() {
      selected.character = null;
      selected.problem = null;
      switchStage(1);
    }
    
    function showLoading(show) {
      document.getElementById('loading').classList.toggle('hidden', !show);
    }
    
    // Load data when page starts
    loadData();
  </script>
